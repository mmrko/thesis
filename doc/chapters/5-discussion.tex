% !TEX root = ../thesis.tex

% Tutkimustuloksien merkitystä on aina syytä arvioida ja tarkastella
% kriittisesti. Tässä osassa on syytä myäs arvioida tutkimustulosten luotettavuutta.

% At this point, you will have some insightful thoughts on your implementation
% and you may have ideas on what could be done in the future. This chapter
% is a good place to discuss your thesis as a whole and to show your professor
% that you have really understood some non-trivial aspects of the methods you
% used. . .

\documentclass[thesis.tex]{subfiles}

\begin{document}

\chapter{Discussion}
\label{chapter:discussion}

This chapter discusses the design decisions taken during the implementation of the application and the findings made based on the the raw result data and the parts of it summarized in \ref{chapter:results}. Last, challenges faced during the project and an outline for future research work are presented. Motivation behind some of the design choices mentioned earlier in the writing are not reiterated here, and the interested reader is instead advised to refer to Chapter \ref{chapter:design-implementation} and the related appendices \ref{appendix:camera-module} and \ref{appendix:capture-presets}.

\section{Design Choices}

One of the challenges early on in the project was the capture of a taggant's photoexcitation. A 3D printed version of the camera module had been developed prior the project for demonstration purposes. It provided good isolation from ambient light and even a built-in slot for different diffraction gratings. It however did not include an integrated light source, and taggants were instead excited manually by toggling a UV flashlight (Nightsearcher UV 365). A programmatic control over the light source was required for product authentication purposes. And, as integration of a smartphone and a light source with the existing 3D printed mold proved difficult, a cardboard prototype was implemented, as presented in \ref{chapter:camera-module}.

The smartphone torch light in both the Samsung S4 and Lumia 1020 did not emit the right kind (wavelength) of light to be able to excite the taggants, and thus, an external light source was required. An external light source would also help in normalizing differences between smartphones and the various kinds of wavelengths their torch lights emit. Programmatic control of the light source required a connection to be established between the smartphone and the light source. Cross-modal communication by means of light signals proved to be a straightforward solution. Connecting the two devices via WiFi, Bluetooth or cable would have added unnecessary complexity in terms of the use case.

As one of the goals of the project was to be able to compare results across different smartphones (as per \ref{R1}), the capture parameters needed to be standardized. For this purpose a set capture presets were defined (see Table \ref{table:capture-presets}). The preset values for the \emph{interval} duration were configured based on the taggants. As described in \cite{luminova}, the Luminova\textregistered pigments have a fairly long emission duration. For a smartphone to be able to capture any significant change in the emission the interval also needed to be long. The appropriate intervals of 200, 400 and 600ms were eventually derived empirically. The preset resolutions were set to the highest preview frame resolution supported by the given platform. As Windows Phone 8.1 did not support preview resolutions higher than $1280\times720$px only three presets were defined for the Lumia 1020.

Different focus strategies were applied depending on the platform. Android 4.4.2 does not support setting focus to a fixed minimum distance. Therefore, macro focus mode was used to guarantee the Samsung S4 could still acquire accurate focus around its MFD. The macro focus mode however required the use of the focus light. The torch light was therefore not used on the Samsung S4 to avoid triggering the light source twice -- the focus light would function as the trigger instead. On the Lumia 1020 the focus could be set to a fixed minimum distance (MFD), and the (torch) light was used only as the light source trigger.

A number of parameters were set to a fixed value (see Table \ref{table:capture-presets-fixed}). The number of frames (samples) to capture per fingerprint was fixed at five frames. It was empirically observed that additional frames would not provide much data due to decreasing Signal-to-noise ratio. Furthermore, capturing more frames would have led to worse experience for the user as the capture and processing times would have gotten longer. Capturing three or four frames could have provided similar results, but as emission peaks could still be detected even after 3000ms for some of the taggants, the frame count was not adjusted. Moreover, it would be trivial to retroactively compute results against four or less frames if necessary.

The camera white balance was set to the \emph{Daylight} preset value as Android 4.4.2 does not support manual white balance adjustment. The Daylight preset was chosen over other available white balance presets as it typically applies the least compensation and corresponded well with the color temperature (5600K) of the experiment light source (Yongnuo YN565EX). The Daylight preset represents roughly a temperature of 5500-6500K depending on the vendor.

Other capture parameters set to a fixed value were \emph{delay} and \emph{ISO}. The time to delay the capture of the first frame (after the light source has been triggered) was determined empirically by observing when the focus light of the Samsung S4 would no longer introduce artefacts. An example of the artefact caused by the interference from the S4's focus light is presented Figure \ref{figure:artefacts}. The interference was believed to have been caused by the decay of the smartphone's led light interfering with the preview feed signal. The Lumia 1020 exhibited no such behaviour. The capture ISO was set to \emph{auto} as Samsung S4 was unable to lock exposure for the time of the capture when a manual ISO value was used. This was believed to be a bug in the camera API of Android 4.4.2 when frames are captured from the preview feed. Ideally, a low ISO value of ISO100 would have been used to avoid introducing any unwanted noise to the pipeline.

The motivation for using hue and hue-saturation histogram analysis as the basis of the fingerprint matching was largely inspired by how luminophores are studied in chemistry by means of spectroscopy. The idea of the histograms was to provide a rough estimate of the ``emission spectrum'' (color distribution) of the taggant. The capture of a proper emission spectrum would have required a way to diffract the incident light (e.g. via a diffraction grating) and apply proper color calibration for translating RGB values into wavelengths. The parameter values used for the fingerprint and histogram methods to analyze and match the capture data were largely based on apriori assumptions and observations how the results changed when a given parameter was adjusted.

Binary thresholding was used as the primary filter due to its simplicity and fit for the context. As the frames consisted of small color blobs on a dark background the dark pixels on the background were easily singled out by a binary thresholding level of 15\%. The hue bin size was set to 180, which is also the maximum number of hue bins OpenCV supports (for 8-bit images). Internally OpenCV's \emph{calcHist()} function encodes the hue values from 360 down to 180 for better performance. The persistance threshold used by the fingerprint method for peak selection was set to 20\% purely based on what threshold would provide neither too many nor too few peaks in general. The implications of this are briefly discussed in Chapter \ref{chapter:findings}.

- binary thresholding (naive but simple and fits the context)
- bin size set to OpenCV max to avoid loss of information
- persistance threshold: purely based on observations of the data
- Penalty weight Damping coefficient Delta threshold
- smaller saturation bin sizes would have most likely added more computation time while having a very low impact on the final score

- Eventual consistency (CouchDB) (http://guide.couchdb.org/draft/consistency.html, http://pouchdb.com/guides/replication.html)
- Schema flexibility (NoSQL) SYNC!

\section{Findings}
\label{chapter:findings}

HOW WOULD FINGERPRINT METHOD PERFORM IF
- BIN SIZE < 180
- FRAMES: 3 or 4

- which taggants perform the best, and why?
- SP <-> O (similar)

- sample a and b not really siblings per se: an\_400\_r/13SVa vs. an\_400\_r/13SVb (taggant preparation)
- Matches against xxx\_r vs the b sample points to the fact that the taggant creation process plays a big role...

- good match: an\_600/24SPa, an\_600\_r/24VPb, wp\_600/24SPa, wp\_600/24SPb

- wp\_600/13VPb: matches everything with fingerprint method, only a few with histogram (=> anomaly)
It was observed from the raw data that wp\_600/13VPb matched surprisingly poorly with rest of the corpus. This was due to (persistance threshold, residue afterglow?):

- example of exposure lock behaviour on Android: [some pic]

% /Users/Make/Documents/dippa/app/luminotrace-native/corpus/data/wp_600/13VPb/2015-05-06-004852
vs.
% /Users/Make/Documents/dippa/app/luminotrace-native/corpus/data/wp_400/13VPb/2015-05-05-184418

- Margin increase => minimal impact for both approaches
- Fingerprint method: more misses (histogram method more stable)
- peak method performs poorly against the histogram approach for single coloured luminophors
- \ref{equation:similarity-metric-no-peaks} - shortcoming of the fingerprint method?

Artefacts!

\section{Challenges and Future Work}
\begin{comment}

Ideally, the taggants would have been captured through a diffraction grating (or a prism)
Color calibration

analysis/match params are very static

There are mainly two modules responsible for the color-rendering accuracy of a digital camera: the former is the illuminant estimation and correction module, and the latter is the color matrix transformation aimed to adapt the color response of the sensor to a standard color space. These two modules together form what may be called the color correction pipeline.

RGB is a device-dependent color model: different devices detect or reproduce a given RGB value differently, since the color elements (such as phosphors or dyes) and their response to the individual R, G, and B levels vary from manufacturer to manufacturer, or even in the same device over time. Thus an RGB value does not define the same color across devices without some kind of color management.
\url{http://www.cis.rit.edu/~jxj1770/publications/paperEI_Xerox.pdf}
\url{http://www.cs.unc.edu/techreports/04-012.pdf}

% https://www.cs.unc.edu/~welch/media/pdf/Ilie2005_Calib.pdf
% Unfortunately most cameras—even of the same typedo not exhibit consistent responses. Figure 1 illustrates the
% differences between the responses of 8 cameras to the 24 colors of the GretagMacbeth [5] ColorCheckerTM chart
% imaged under the same illumination conditions and using the same hardware settings. The data shows that color
% values are significantly different from camera to camera. This is due for example to aperture variations, fabrication
% variations, electrical noise, and interpolation artifacts arising from the reconstruction of a full-resolution color image
% from a half-resolution Bayer pattern image

\end{comment}

- thus it be better to add some structural \& spatial similarity semantics (- more novel selection criterion) - analogies to existing solutions (InkSure \& CryptoGlyph)
  - alternative approach: colored dots form a discrete pattern, no grating necessary
- high res images could be used as camera APIs improve
% - The preview feed was used since the Android and Windows Phone versions (Kitkat and 8.1, respectively) lacked the proper support for burst mode (image capture at a predefined interval). Furthermore, frames could not be captured individually as Thus, there was no way to schedule the capture to take place at a specific interval.

- YCbCr suffers from clipping (https://en.wikipedia.org/wiki/YCbCr)
- color calibration (requires use of RAW data)
  - CCD > CMOS koska parempi herkkyys
- device detection (automatic configuration, database per phone model)
- iOS support (ios with c++? On iOS this extra bridge is unnecessary as C++ code can directly invoke Objective-C APIs.)
- more efficient matching if done server-side (leverage histogram data directly?)
  - easy to switch over because the offline-first approach taken
- change management / how to handle updates \& different devices?
- use histogram method. Fingerprint method useful for querying/filtering?
- more sophisticated peak finding / matching algorithms
- use of diffraction grating and spectral analysis
- get hold of the device or man-in-the-middle (metadata works as a layer of indirection)
using a predefined username and password (easily extendable to a real user auth)
- CouchDB uses a traditional cookie based authentication scheme, and as such, applications can be vulnerable to CSRF attacks. However, the application has no CSRF attacks vectors as it the DBMS and the application server is read-only
Traditional Cookie-Based Auth (could be extended to Modern Token-Based Auth such as JWT)

% \subsection{Taggant}
- phosphorescence vs. fluorescence (infeasible coz time)
- Afterglow brightness is also proportional to the intensity of UV contained in the excitation light.
- LumiNova pigments originally developed for use in watch dials
- Erilaisilla hiloilla, suodattimilla, raoilla ja peileilla on ehdottoman tarkea tehtavansa riittavan resoluution aikaansaamiseksi ja jotta saadaan valituksi tarkka viritysaallonpituus ja saadaan minimoiduksi sironta ja taustaluminesenssi. aikaerotteisen maarityksen etuna on se, etta viritysvalo ehtii sammua kokonaan ja sirontailmioiden aiheuttaman taustan vaikutus poistuu. Pitka elinika mahdollistaa myos edullisen ja varsin yksinkertaisen laitteiston kayton.122,124
- idempotence of the luminphores (photobleach)


\end{document}